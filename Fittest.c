#include<stdio.h>
#include<math.h>
#define RXBUFFER_LENGTH 1024
#define DATA_LENGTH 500
#define V_LENGTH 250
#define I_LENGTH 250
#define PI 3.141593
#define f 100000

void Decoder_8bit_to_12bit(unsigned char* RxData_8bit, int length_8bit, unsigned int* RxData_12bit);
void Digit_to_Analog(unsigned int* D_Vpp, double* A_Vpp);
void IV_DataDistribution(double All_Input[], double V_Input[], double I_Input[]);
void IQ_Algorithm(double* x, double* y, double* uQ2, double* uI2);
void Multiplier(double* Input_1, double* Input_2, double* Output);
void Phaser(double* Input_Signal, double Input_Angle, int Input_Signal_Length, int Input_Signal_Period, double* Output);
double LowPasser(double* Input_Signal, int Input_Length);
void GetC_D(double uQ, double uI, double* C, double* D);
void GetL_Q(double uQ, double uI, double* L, double* Q);


int main()
{
    unsigned char RxValidData_In[]={0xFF,0xE3,0x79,0xF2,0x10,0x00,0x10,0x00,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF};
    unsigned int RxValidData_Out[DATA_LENGTH];
    double All_Input[DATA_LENGTH];
    double V_Input[V_LENGTH];
    double I_Input[I_LENGTH];
    double uQ, uI;
    double Gain, dphi;
    double C, D;
    double L, Q;

    Decoder_8bit_to_12bit(RxValidData_In, sizeof(RxValidData_In), RxValidData_Out);
    Digit_to_Analog(RxValidData_Out, All_Input);
    IV_DataDistribution(All_Input, V_Input, I_Input);

    IQ_Algorithm(I_Input, V_Input, &uQ, &uI);

    GetC_D(uQ, uI, &C, &D);
    GetL_Q(uQ, uI, &L, &Q);
}

void Decoder_8bit_to_12bit(unsigned char* RxData_8bit, int length_8bit, unsigned int* RxData_12bit)
{
    for (int i = 0; i < (length_8bit/3); i++)
    {
        RxData_12bit[i*2] = (RxData_8bit[i*3] << 4) + (RxData_8bit[i*3+1] >> 4);
        RxData_12bit[i*2+1] = ((RxData_8bit[i*3+1] & 0x0F) << 8 )+ RxData_8bit[i*3+2];
    }
}

void Digit_to_Analog(unsigned int* D_Vpp, double* A_Vpp)
{
    for (int i = 0; i < DATA_LENGTH; i++)
    {
        A_Vpp[i] = 5.0 * (2048 - (int)D_Vpp[i]) / 2048 ;
        printf("%d:%d\t%.4lf\n",i,D_Vpp[i],A_Vpp[i]);
    }
}

void IV_DataDistribution(double All_Input[], double V_Input[], double I_Input[])
{
    for (int i = 0; i < V_LENGTH; i++)
    {
        V_Input[i] = All_Input[i];
    }
    for (int i = 0; i < I_LENGTH; i++)
    {
        I_Input[i] = All_Input[256 + i];
    }
}

void IQ_Algorithm(double* x, double* y, double* uQ2, double* uI2)
{
    double y_90[V_LENGTH];
    double uQ1[V_LENGTH];
    double uI1[V_LENGTH];
    /*
        x(t) -> i(t)
        y(t) -> u(t)
    */
    Phaser(y, (PI / 2), V_LENGTH, V_LENGTH, y_90);

    Multiplier(x, y_90, uQ1);
    Multiplier(x, y, uI1);

    *uQ2 = LowPasser(uQ1, V_LENGTH);
    *uI2 = LowPasser(uI1, V_LENGTH);
}

void Multiplier(double* Input_1, double* Input_2, double* Output)
{
    for (int i = 0; i < V_LENGTH; i++)
    {
        Output[i] = Input_1[i] * Input_2[i];
    }
    
}

void Phaser(double* Input_Signal, double Input_Angle, int Input_Signal_Length, int Input_Signal_Period, double* Output)
{
    /*example: Input_Angle = PI/2*/
    int signal_Offset;
    signal_Offset = Input_Angle * Input_Signal_Period / (2*PI);
    for (int i = 0; i < Input_Signal_Length; i++)
    {  
        if(i < (Input_Signal_Period - signal_Offset))
        {
            Output[i + signal_Offset] = Input_Signal[i];
        }
        else
        {
            Output[i - (Input_Signal_Period - signal_Offset)] = Input_Signal[i];
        }
    }  
}

double LowPasser(double* Input_Signal, int Input_Length)
{
    double Sum = 0;
    double Output = 0;
    for (int i = 0; i < Input_Length; i++)
    {
        Sum += Input_Signal[i];
    }
    Output = Sum / Input_Length;
    return Output;
}

void GetC_D(double uQ, double uI, double* C, double* D)
{
    if(uQ > 0)
    {
        *C = 1 / (4 * PI * f * uQ);
    }
    else
    {
        *C = -1 / (4 * PI * f * uQ);
    }
    
    *D = - uI / uQ;
}

void GetL_Q(double uQ, double uI, double* L, double* Q)
{
    if(uQ > 0)
    {
        *L = (pow(uI, 2) + pow(uQ, 2)) / (PI * f * uQ);
    }
    else
    {
        *L = -(pow(uI, 2) + pow(uQ, 2)) / (PI * f * uQ);
    }

    *Q = uI / uQ;
}