#include<stdio.h>
#include<math.h>
#define RXBUFFER_LENGTH 1024
#define DATA_LENGTH 500
#define V_LENGTH 250
#define I_LENGTH 250
#define PI 3.141593

void Decoder_8bit_to_12bit(unsigned char* RxData_8bit, int length_8bit, unsigned int* RxData_12bit);
void Digit_to_Analog(unsigned int* D_Vpp, double* A_Vpp);
void IV_DataDistribution(double All_Input[], double V_Input[], double I_Input[]);
void IQ_Algorithm(double* x, double* y, double* uQ2, double* uI2);
void Multiplier(double* Input_1, double* Input_2, double* Output);
void Phaser(double* Input_Signal, double Input_Angle, int Input_Signal_Length, int Input_Signal_Period, double* Output);
double LowPasser(double* Input_Signal, int Input_Length);

int main()
{
    unsigned char RxValidData_In[]={0xFF,0xE3,0x79,0xF2,0x10,0x00,0x10,0x00,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF};
    unsigned int RxValidData_Out[DATA_LENGTH];
    double All_Input[DATA_LENGTH];
    double V_Input[V_LENGTH];
    double I_Input[I_LENGTH];
    double uQ, uI;
    double Gain, dphi;
//         double test_Vpp[V_LENGTH]={0.025130095,
// 0.050244318,
// 0.075326806,
// 0.100361715,
// 0.125333234,
// 0.150225589,
// 0.175023059,
// 0.199709981,
// 0.224270761,
// 0.248689887,
// 0.272951936,
// 0.297041582,
// 0.32094361,
// 0.344642923,
// 0.368124553,
// 0.391373667,
// 0.414375581,
// 0.437115767,
// 0.459579861,
// 0.481753674,
// 0.503623202,
// 0.52517463,
// 0.546394347,
// 0.567268949,
// 0.587785252,
// 0.607930298,
// 0.627691361,
// 0.647055962,
// 0.666011867,
// 0.684547106,
// 0.70264997,
// 0.720309025,
// 0.737513117,
// 0.754251381,	
// 0.770513243,
// 0.786288432,
// 0.801566985,
// 0.816339251,
// 0.830595899,
// 0.844327926,
// 0.857526656,
// 0.870183755,
// 0.882291226,
// 0.893841424,
// 0.904827052,
// 0.915241173,
// 0.925077207,
// 0.934328942,
// 0.942990536,
// 0.951056516,
// 0.958521789,
// 0.965381639,
// 0.971631733,
// 0.977268124,
// 0.982287251,
// 0.986685944,
// 0.990461426,
// 0.993611311,
// 0.996133609,
// 0.998026728,
// 0.999289473,
// 0.999921044,
// 0.999921044,
// 0.999289473,
// 0.998026728,
// 0.996133609,
// 0.993611311,
// 0.990461426,
// 0.986685944,
// 0.982287251,
// 0.977268124,
// 0.971631733,
// 0.965381639,
// 0.958521789,
// 0.951056516,
// 0.942990536,
// 0.934328942,
// 0.925077207,
// 0.915241173,
// 0.904827052,
// 0.893841424,
// 0.882291226,
// 0.870183755,
// 0.857526656,
// 0.844327926,
// 0.830595899,
// 0.816339251,
// 0.801566985,
// 0.786288432,
// 0.770513243,
// 0.754251381,
// 0.737513117,
// 0.720309025,
// 0.70264997,
// 0.684547106,
// 0.666011867,
// 0.647055962,
// 0.627691361,
// 0.607930298,
// 0.587785252,
// 0.567268949,
// 0.546394347,
// 0.52517463,
// 0.503623202,
// 0.481753674,
// 0.459579861,
// 0.437115767,
// 0.414375581,
// 0.391373667,
// 0.368124553,
// 0.344642923,
// 0.32094361,
// 0.297041582,
// 0.272951936,
// 0.248689887,
// 0.224270761,
// 0.199709981,
// 0.175023059,
// 0.150225589,
// 0.125333234,
// 0.100361715,
// 0.075326806,
// 0.050244318,
// 0.025130095,
// 1.22515E-16,
// -0.025130095,
// -0.050244318,
// -0.075326806,
// -0.100361715,
// -0.125333234,
// -0.150225589,
// -0.175023059,
// -0.199709981,
// -0.224270761,
// -0.248689887,
// -0.272951936,
// -0.297041582,
// -0.32094361,
// -0.344642923,
// -0.368124553,
// -0.391373667,
// -0.414375581,
// -0.437115767,
// -0.459579861,
// -0.481753674,
// -0.503623202,
// -0.52517463,
// -0.546394347,
// -0.567268949,
// -0.587785252,
// -0.607930298,
// -0.627691361,
// -0.647055962,
// -0.666011867,
// -0.684547106,
// -0.70264997,
// -0.720309025,
// -0.737513117,
// -0.754251381,
// -0.770513243,
// -0.786288432,
// -0.801566985,
// -0.816339251,
// -0.830595899,
// -0.844327926,
// -0.857526656,
// -0.870183755,
// -0.882291226,
// -0.893841424,
// -0.904827052,
// -0.915241173,
// -0.925077207,
// -0.934328942,
// -0.942990536,
// -0.951056516,
// -0.958521789,
// -0.965381639,
// -0.971631733,
// -0.977268124,
// -0.982287251,
// -0.986685944,
// -0.990461426,
// -0.993611311,
// -0.996133609,
// -0.998026728,
// -0.999289473,
// -0.999921044,
// -0.999921044,
// -0.999289473,
// -0.998026728,
// -0.996133609,
// -0.993611311,
// -0.990461426,
// -0.986685944,
// -0.982287251,
// -0.977268124,
// -0.971631733,
// -0.965381639,
// -0.958521789,
// -0.951056516,
// -0.942990536,
// -0.934328942,
// -0.925077207,
// -0.915241173,
// -0.904827052,
// -0.893841424,
// -0.882291226,
// -0.870183755,
// -0.857526656,
// -0.844327926,
// -0.830595899,
// -0.816339251,
// -0.801566985,
// -0.786288432,
// -0.770513243,
// -0.754251381,
// -0.737513117,
// -0.720309025,
// -0.70264997,
// -0.684547106,
// -0.666011867,
// -0.647055962,
// -0.627691361,
// -0.607930298,
// -0.587785252,
// -0.567268949,
// -0.546394347,
// -0.52517463,
// -0.503623202,
// -0.481753674,
// -0.459579861,
// -0.437115767,
// -0.414375581,
// -0.391373667,
// -0.368124553,
// -0.344642923,
// -0.32094361,
// -0.297041582,
// -0.272951936,
// -0.248689887,
// -0.224270761,
// -0.199709981,
// -0.175023059,
// -0.150225589,
// -0.125333234,
// -0.100361715,
// -0.075326806,
// -0.050244318,
// -0.025130095,
// -2.4503E-16,};

    // double test_Output[V_LENGTH];
    // double test_Output;

    Decoder_8bit_to_12bit(RxValidData_In, sizeof(RxValidData_In), RxValidData_Out);
    Digit_to_Analog(RxValidData_Out, All_Input);
    IV_DataDistribution(All_Input, V_Input, I_Input);

    IQ_Algorithm(I_Input, V_Input, &uQ, &uI);
    GetGain_deltaphi(uQ, uI, &Gain, &dphi);
    printf("A=%f, deltaPHI=%f\n",Gain, dphi);


    // Phaser(test_Vpp, (PI/2), 250, 250, test_Output);
    // for (int i = 0; i < V_LENGTH; i++)
    // {
    //     printf("%.3f\n",test_Output[i]);
    // }
    //test_Output = LowPasser(test_Vpp, V_LENGTH);
    //printf("090 \t%f",test_Output);
    // for (int i = 0; i < V_LENGTH; i++)
    // {
    //     printf("%f\n",V_Input[i]);
    // }
    // printf("--------------\n");
    // for (int i = 0; i < I_LENGTH; i++)
    // {
    //     printf("%f\n",I_Input[i]);
    // }
    //printf("%d",RxValidData_Out[0]);
}

void Decoder_8bit_to_12bit(unsigned char* RxData_8bit, int length_8bit, unsigned int* RxData_12bit)
{
    for (int i = 0; i < (length_8bit/3); i++)
    {
        RxData_12bit[i*2] = (RxData_8bit[i*3] << 4) + (RxData_8bit[i*3+1] >> 4);
        RxData_12bit[i*2+1] = ((RxData_8bit[i*3+1] & 0x0F) << 8 )+ RxData_8bit[i*3+2];
    }
}

void Digit_to_Analog(unsigned int* D_Vpp, double* A_Vpp)
{
    for (int i = 0; i < DATA_LENGTH; i++)
    {
        A_Vpp[i] = 5.0 * (2048 - (int)D_Vpp[i]) / 2048 ;
        printf("%d:%d\t%.4lf\n",i,D_Vpp[i],A_Vpp[i]);
    }
}

void IV_DataDistribution(double All_Input[], double V_Input[], double I_Input[])
{
    for (int i = 0; i < V_LENGTH; i++)
    {
        V_Input[i] = All_Input[i];
    }
    for (int i = 0; i < I_LENGTH; i++)
    {
        I_Input[i] = All_Input[256 + i];
    }
}

void IQ_Algorithm(double* x, double* y, double* uQ2, double* uI2)
{
    double y_90[V_LENGTH];
    double uQ1[V_LENGTH];
    double uI1[V_LENGTH];
    /*
        x(t) -> i(t)
        y(t) -> u(t)
    */
    Phaser(y, (PI / 2), V_LENGTH, V_LENGTH, y_90);

    Multiplier(x, y_90, uQ1);
    Multiplier(x, y, uI1);

    *uQ2 = LowPasser(uQ1, V_LENGTH);
    *uI2 = LowPasser(uI1, V_LENGTH);
}

void Multiplier(double* Input_1, double* Input_2, double* Output)
{
    for (int i = 0; i < V_LENGTH; i++)
    {
        Output[i] = Input_1[i] * Input_2[i];
    }
    
}

void Phaser(double* Input_Signal, double Input_Angle, int Input_Signal_Length, int Input_Signal_Period, double* Output)
{
    /*example: Input_Angle = PI/2*/
    int signal_Offset;
    signal_Offset = Input_Angle * Input_Signal_Period / (2*PI);
    for (int i = 0; i < Input_Signal_Length; i++)
    {  
        if(i < (Input_Signal_Period - signal_Offset))
        {
            Output[i + signal_Offset] = Input_Signal[i];
        }
        else
        {
            Output[i - (Input_Signal_Period - signal_Offset)] = Input_Signal[i];
        }
    }  
}

double LowPasser(double* Input_Signal, int Input_Length)
{
    double Sum = 0;
    double Output = 0;
    for (int i = 0; i < Input_Length; i++)
    {
        Sum += Input_Signal[i];
    }
    Output = Sum / Input_Length;
    return Output;
}

void GetGain_deltaphi(double uQ, double uI, double* Gain, double* deltaphi)
{
    *Gain = 2 * sqrt((pow(uQ, 2) + pow(uQ, 2)));
    *deltaphi = -atan((uQ / uI));
}